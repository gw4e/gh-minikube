name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Get code
        uses: actions/checkout@v4
      - name: Build
        run: |
          docker build -t gh-flask-app:v1 .
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Start Minikube
        id: minikube
        uses: medyagh/setup-minikube@master
      - name: Check Minikube Status
        run: minikube status
      - name: Get Kubernetes Nodes
        run: kubectl get nodes
      - name: Enable Ingress
        run: minikube addons enable ingress
      - name: List addons
        run  : minikube addons list
      - name: Check Ingress
        run: kubectl get pods -n ingress-nginx
      - name: Get code
        uses: actions/checkout@v4
      - name : Deploy web server
        run : kubectl apply -f webserver.yaml
      - name : Plug Ingress
        run : kubectl apply -f ingress.yaml
